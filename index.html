<!doctype html>
<html lang="uk">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Euro Standart — Абонементи води</title>

<!-- Tailwind CSS CDN -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

<!-- QRCode library -->
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>

<style>
  :root {
    --blue-light: #3b82f6;
    --blue-dark: #1e40af;
    --bg-gradient-start: #e0f2fe;
    --bg-gradient-end: #bae6fd;
    --card-bg: #ffffffcc;
    --shadow: rgba(30, 64, 175, 0.3);
  }

  body {
    font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif;
    background: linear-gradient(180deg, var(--bg-gradient-start), var(--bg-gradient-end));
    min-height: 100vh;
    padding: 20px;
    color: #1e40af;
  }

  .card {
    background: var(--card-bg);
    border-radius: 20px;
    box-shadow: 0 10px 25px var(--shadow);
    backdrop-filter: saturate(180%) blur(12px);
    padding: 20px;
    transition: box-shadow 0.3s ease;
  }
  .card:hover {
    box-shadow: 0 15px 40px var(--shadow);
  }

  .btn-primary {
    background: linear-gradient(90deg, #2563eb, #3b82f6);
    color: white;
    font-weight: 600;
    border-radius: 12px;
    padding: 12px 20px;
    box-shadow: 0 4px 14px rgba(59,130,246,0.39);
    transition: background 0.3s ease;
  }
  .btn-primary:hover {
    background: linear-gradient(90deg, #1e40af, #2563eb);
  }
  .btn-outline {
    border: 2px solid #3b82f6;
    color: #1e40af;
    font-weight: 600;
    border-radius: 12px;
    padding: 10px 18px;
    background: transparent;
    transition: background 0.3s ease, color 0.3s ease;
  }
  .btn-outline:hover {
    background: #3b82f6;
    color: white;
  }

  input, select {
    border-radius: 12px;
    border: 2px solid #3b82f6;
    padding: 10px 15px;
    font-weight: 500;
    outline-offset: 2px;
    outline-color: #60a5fa;
    transition: border-color 0.3s ease;
  }
  input:focus, select:focus {
    border-color: #2563eb;
  }

  header {
    margin-bottom: 25px;
  }

  .fade-in {
    animation: fadeInUp 0.5s ease forwards;
  }
  @keyframes fadeInUp {
    from { opacity: 0; transform: translateY(12px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .qr-canvas {
    margin: auto;
    display: block;
  }

  /* Scrollbars */
  ::-webkit-scrollbar {
    width: 8px;
  }
  ::-webkit-scrollbar-track {
    background: #e0f2fe;
  }
  ::-webkit-scrollbar-thumb {
    background: #3b82f6;
    border-radius: 10px;
  }
</style>
</head>
<body>

<div class="max-w-4xl mx-auto space-y-8">
  <header class="flex items-center justify-between">
    <div class="flex items-center gap-4">
      <div class="w-16 h-16 rounded-xl bg-gradient-to-r from-blue-600 to-blue-400 flex items-center justify-center font-extrabold text-white text-2xl select-none cursor-default">ES</div>
      <div>
        <div class="text-blue-700 font-semibold text-sm select-none">Euro Standart</div>
        <h1 class="text-3xl font-extrabold leading-tight select-none">Точка розливу — Абонементи води</h1>
      </div>
    </div>
    <div class="text-blue-600 text-sm select-none">Зворотній осмос • УФ-лампа • Активоване вугілля</div>
  </header>

  <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">

    <!-- Регистрация / Пользователь -->
    <section class="lg:col-span-2 card relative min-h-[440px]">

      <!-- Регистрация -->
      <div id="view-register" class="fade-in space-y-5">
        <h2 class="text-xl font-bold text-blue-800">Реєстрація клієнта</h2>
        <p class="text-blue-700 font-medium">Введіть ім'я та телефон. Можна вказати код запрошення друга.</p>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-3">
          <input id="regName" type="text" placeholder="Ім'я" autocomplete="name" />
          <input id="regPhone" type="tel" placeholder="Телефон +380..." autocomplete="tel" />
          <input id="regInvite" type="text" placeholder="Код запрошення (необов'язково)" class="md:col-span-2" autocomplete="off" />
          <button id="btnReg" class="btn-primary md:col-span-1">Зареєструватися</button>
          <button id="btnUseCode" class="btn-outline md:col-span-1">Увійти по коду</button>
        </div>
      </div>

      <!-- Пользователь -->
      <div id="view-user" class="hidden fade-in flex flex-col space-y-6">
        <div class="flex justify-between items-center">
          <div>
            <div class="text-sm font-semibold text-blue-500 select-none">Ваш індивідуальний код</div>
            <div id="userCode" class="text-3xl font-extrabold text-blue-900 select-text cursor-text">#0000</div>
          </div>
          <div class="text-right">
            <div class="text-sm font-semibold text-blue-500 select-none">Баланс</div>
            <div id="userBalance" class="text-2xl font-extrabold text-blue-900 select-text cursor-default">0 грн</div>
          </div>
        </div>

        <div class="flex gap-4 flex-wrap">
          <button id="btnTopup" class="btn-primary flex-1 min-w-[160px]">Поповнити (заявка)</button>
          <button id="btnHistory" class="btn-outline flex-1 min-w-[160px]">Історія</button>
          <button id="btnQR" class="btn-outline flex-1 min-w-[160px]">Показати QR-код</button>
        </div>

        <div class="flex gap-4 flex-wrap">
          <button id="btnSubscribeWeek" class="btn-outline flex-1 min-w-[160px]">Підписка: щотижня</button>
          <button id="btnSubscribeMonth" class="btn-outline flex-1 min-w-[160px]">Підписка: щомісяця</button>
        </div>

        <div>
          <button id="btnShare" class="btn-primary w-full">Бонуси та реферальне</button>
        </div>

        <div>
          <button id="btnLogout" class="btn-outline w-full">Вийти</button>
        </div>
      </div>

      <!-- QR Код Модал -->
      <div id="qrModal" class="fixed inset-0 bg-black/40 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-2xl p-6 max-w-sm w-full text-center shadow-lg relative">
          <h3 class="text-xl font-bold mb-4 text-blue-900">Ваш QR-код</h3>
          <canvas id="qrCanvas" class="qr-canvas mx-auto mb-4"></canvas>
          <button id="btnCloseQR" class="btn-outline w-full">Закрити</button>
        </div>
      </div>

    </section>

    <!-- Адмінка -->
    <aside class="card space-y-6 min-h-[440px]">
      <h2 class="text-xl font-bold text-blue-800 select-none">Адмін-панель</h2>
      <p class="text-blue-700 font-medium select-none">Увійдіть для обробки заявок і керування користувачами.</p>

      <button id="btnAdminLogin" class="btn-primary w-full">Увійти (адмін)</button>

      <div id="adminPanel" class="hidden flex flex-col space-y-4">
        <div>
          <h3 class="text-lg font-semibold text-blue-700 select-none mb-2">Заявки на поповнення</h3>
          <div id="topupsList" class="max-h-48 overflow-y-auto rounded border border-blue-300 p-3 space-y-3 bg-white"></div>
        </div>

        <div>
          <h3 class="text-lg font-semibold text-blue-700 select-none mb-2">Користувачі</h3>
          <div id="usersList" class="max-h-64 overflow-y-auto rounded border border-blue-300 p-3 space-y-3 bg-white"></div>
        </div>

        <button id="btnAdminLogout" class="btn-outline w-full">Вийти з адмінки</button>
      </div>
    </aside>

  </main>

  <footer class="text-center text-blue-600 text-sm select-none">© Euro Standart — Система розливу води</footer>
</div>

<!-- Модал: Історія -->
<div id="modal" class="fixed inset-0 bg-black/30 flex items-center justify-center p-4 hidden z-40">
  <div class="bg-white rounded-2xl p-6 max-w-lg w-full shadow-lg max-h-[80vh] overflow-y-auto relative">
    <div id="modalContent"></div>
    <button id="modalClose" class="btn-outline mt-6 w-full">Закрити</button>
  </div>
</div>

<script>
(() => {
  const STORAGE_KEY = 'eurostandart_v2';

  /* Data structure */
  let DB = null;

  /* DOM helpers */
  const $ = id => document.getElementById(id);
  const show = el => el.classList.remove('hidden');
  const hide = el => el.classList.add('hidden');

  /* Modal */
  const modal = $('modal');
  const modalContent = $('modalContent');
  const modalClose = $('modalClose');
  modalClose.onclick = () => hide(modal);

  /* QR Modal */
  const qrModal = $('qrModal');
  const qrCanvas = $('qrCanvas');
  const btnCloseQR = $('btnCloseQR');
  btnCloseQR.onclick = () => hide(qrModal);

  /* State */
  let currentUserCode = localStorage.getItem('es_current_code') || null;
  let isAdmin = false;

  /* Load data or init */
  function safeParseJSON(str) {
    try { return JSON.parse(str); }
    catch { return null; }
  }
  function loadData() {
    const raw = localStorage.getItem(STORAGE_KEY);
    const parsed = safeParseJSON(raw);
    if (!parsed || !parsed.users || !parsed.topups || !parsed.subscriptions) {
      const base = { users: [], topups: [], subscriptions: [] };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(base));
      return base;
    }
    return parsed;
  }
  function saveData() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(DB));
  }

  function genCode() {
    let code;
    do {
      code = '#' + Math.floor(1000 + Math.random() * 9000);
    } while (DB.users.find(u => u.code === code));
    return code;
  }

  function byCode(code) {
    return DB.users.find(u => u.code === code);
  }

  function fmt(n) {
    return (Number(n) || 0) + ' грн';
  }

  function now() {
    return Date.now();
  }

  /* Escape HTML */
  function escapeHtml(s) {
    if (s === undefined || s === null) return '';
    return String(s).replace(/[&<>"']/g, c =>
      ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[c])
    );
  }

  /* Render */

  function renderUserView(code) {
    const user = byCode(code);
    if (!user) return alert('Користувача не знайдено');
    hide($('view-register'));
    show($('view-user'));

    $('userCode').textContent = user.code;
    $('userBalance').textContent = fmt(user.balance);
  }

  function renderRegisterView() {
    hide($('view-user'));
    show($('view-register'));
  }

  function renderAdminPanel() {
    // Show admin panel UI and fill users and topups
    show($('adminPanel'));

    // Topups list
    const topups = DB.topups.filter(t => !t.processed);
    const topupsList = $('topupsList');
    topupsList.innerHTML = '';
    if (!topups.length) {
      topupsList.innerHTML = '<p class="text-blue-500 select-none">Немає заявок на поповнення</p>';
    } else {
      topups.forEach(t => {
        const u = byCode(t.code) || { name: '—' };
        const div = document.createElement('div');
        div.className = 'flex justify-between items-center bg-blue-50 rounded p-2';
        div.innerHTML = `
          <div>
            <p class="font-semibold text-blue-700">${escapeHtml(u.name)} <span class="text-sm text-blue-400">(${escapeHtml(t.code)})</span></p>
            <p class="text-sm text-blue-600">Сума: <strong>${t.amount} грн</strong> — заявка</p>
          </div>
          <div class="flex gap-2">
            <button class="btn-primary btn-proc px-3 py-1 rounded" data-id="${t.id}">Підтвердити</button>
            <button class="btn-outline btn-rej px-3 py-1 rounded" data-id="${t.id}">Відхилити</button>
          </div>
        `;
        topupsList.appendChild(div);
      });
    }

    // Users list
    const usersList = $('usersList');
    usersList.innerHTML = '';
    if (!DB.users.length) {
      usersList.innerHTML = '<p class="text-blue-500 select-none">Немає користувачів</p>';
    } else {
      DB.users.forEach(u => {
        const div = document.createElement('div');
        div.className = 'flex flex-col gap-1 p-2 rounded border border-blue-200 bg-blue-50';
        div.innerHTML = `
          <div class="flex justify-between items-center">
            <div>
              <p class="font-semibold text-blue-700">${escapeHtml(u.name)}</p>
              <p class="text-sm text-blue-600 select-text">${escapeHtml(u.phone)}</p>
              <p class="text-sm text-blue-600 select-text">Код: <strong>${u.code}</strong></p>
              <p class="text-sm text-blue-700 font-semibold">Баланс: ${fmt(u.balance)}</p>
            </div>
            <div class="flex flex-col gap-2">
              <button class="btn-outline btn-adjust px-3 py-1 rounded" data-code="${u.code}">Регул.</button>
              <button class="btn-outline btn-viewhist px-3 py-1 rounded" data-code="${u.code}">Іст.</button>
              <button class="btn-outline btn-populateqr px-3 py-1 rounded" data-code="${u.code}">QR</button>
            </div>
          </div>
        `;
        usersList.appendChild(div);
      });
    }

    // Attach button handlers for topups
    document.querySelectorAll('.btn-proc').forEach(btn => {
      btn.onclick = () => processTopup(Number(btn.dataset.id), true);
    });
    document.querySelectorAll('.btn-rej').forEach(btn => {
      btn.onclick = () => processTopup(Number(btn.dataset.id), false);
    });

    // Attach button handlers for users list
    document.querySelectorAll('.btn-adjust').forEach(btn => {
      btn.onclick = () => {
        const code = btn.dataset.code;
        const sumStr = prompt('Введіть суму (від\'ємне число для списання)', '100');
        if (!sumStr) return;
        const sum = Number(sumStr);
        if (isNaN(sum)) {
          alert('Некоректна сума');
          return;
        }
        adjustBalance(code, sum, 'Ручна корекція');
        alert('Баланс змінено');
        renderAdminPanel();
      };
    });
    document.querySelectorAll('.btn-viewhist').forEach(btn => {
      btn.onclick = () => {
        const code = btn.dataset.code;
        const user = byCode(code);
        if (!user) return alert('Користувача не знайдено');
        showHistoryModal(user);
      };
    });
    document.querySelectorAll('.btn-populateqr').forEach(btn => {
      btn.onclick = () => {
        const code = btn.dataset.code;
        showQRModal(code);
      };
    });
  }

  /* Process topup: confirmed or rejected */
  function processTopup(id, confirm) {
    const idx = DB.topups.findIndex(t => t.id === id);
    if (idx === -1) return alert('Заявка не знайдена');
    if (confirm) {
      // Поповнюємо баланс користувача
      const t = DB.topups[idx];
      const user = byCode(t.code);
      if (!user) return alert('Користувача не знайдено');
      user.balance = (user.balance || 0) + t.amount;
      if (!user.history) user.history = [];
      user.history.push({ date: now(), type: 'Поповнення (адмін)', amount: t.amount });
      // Якщо перше поповнення, +10 бонус
      if (!DB.subscriptions.includes(user.code)) {
        user.balance += 10;
        user.history.push({ date: now(), type: 'Бонус 10 грн (перше поповнення)', amount: 10 });
        DB.subscriptions.push(user.code);
      }
      t.processed = true;
      saveData();
      alert(`Поповнення ${t.amount} грн підтверджено.\nБаланс оновлено.`);
    } else {
      DB.topups.splice(idx, 1);
      alert('Заявка відхилена та видалена.');
    }
    renderAdminPanel();
  }

  /* Регулюємо баланс */
  function adjustBalance(code, sum, reason = 'Адмін корекція') {
    const user = byCode(code);
    if (!user) return alert('Користувача не знайдено');
    user.balance = (user.balance || 0) + sum;
    if (!user.history) user.history = [];
    user.history.push({ date: now(), type: reason, amount: sum });
    saveData();
  }

  /* Історія */
  function showHistoryModal(user) {
    if (!user.history || user.history.length === 0) {
      modalContent.innerHTML = `<p class="text-blue-700">Історія відсутня.</p>`;
    } else {
      const rows = user.history
        .slice().reverse()
        .map(h => {
          const d = new Date(h.date);
          const dt = d.toLocaleString('uk-UA', { dateStyle: 'short', timeStyle: 'short' });
          const amt = h.amount >= 0 ? `+${h.amount} грн` : `${h.amount} грн`;
          return `<li><strong>${escapeHtml(h.type)}</strong> — ${amt} <span class="text-xs text-blue-400">(${dt})</span></li>`;
        }).join('');
      modalContent.innerHTML = `<ul class="list-disc pl-5 text-blue-800">${rows}</ul>`;
    }
    show(modal);
  }

  /* QR Modal */
  function showQRModal(code) {
    qrModal.classList.remove('hidden');
    qrCanvas.width = 180;
    qrCanvas.height = 180;
    QRCode.toCanvas(qrCanvas, code, { width: 180 }, err => {
      if (err) console.error(err);
    });
  }

  /* Регистрация */
  function registerUser(name, phone, inviteCode) {
    name = name.trim();
    phone = phone.trim();
    inviteCode = inviteCode.trim();
    if (!name || !phone) {
      alert('Введіть ім\'я та телефон');
      return null;
    }
    // Проверка телефона (украинский формат +380...)
    if (!/^(\+?380\d{9})$/.test(phone)) {
      alert('Телефон повинен бути у форматі +380XXXXXXXXX');
      return null;
    }
    // Проверяем, есть ли пользователь с таким телефоном
    let existingUser = DB.users.find(u => u.phone === phone);
    if (existingUser) {
      alert('Цей телефон вже зареєстрований. Ви автоматично увійдете.');
      currentUserCode = existingUser.code;
      localStorage.setItem('es_current_code', currentUserCode);
      saveData();
      return existingUser;
    }

    const newCode = genCode();

    // Создаем пользователя
    const user = {
      id: Date.now(),
      name,
      phone,
      code: newCode,
      balance: 0,
      history: []
    };

    DB.users.push(user);

    // Бонус за приглашение
    if (inviteCode) {
      const inviter = byCode(inviteCode);
      if (inviter) {
        inviter.balance += 10;
        inviter.history.push({ date: now(), type: `Реферальний бонус (+10 грн)`, amount: 10 });
        user.balance += 10; // и сам приглашенный тоже бонус
        user.history.push({ date: now(), type: 'Реферальний бонус за вхід (+10 грн)', amount: 10 });
      }
    }

    saveData();
    currentUserCode = newCode;
    localStorage.setItem('es_current_code', currentUserCode);

    return user;
  }

  /* Вхід по коду */
  function loginByCode(code) {
    code = code.trim();
    if (!code.startsWith('#')) code = '#' + code;
    const user = byCode(code);
    if (!user) {
      alert('Користувача з таким кодом не знайдено');
      return null;
    }
    currentUserCode = user.code;
    localStorage.setItem('es_current_code', currentUserCode);
    return user;
  }

  /* Выход */
  function logout() {
    currentUserCode = null;
    isAdmin = false;
    localStorage.removeItem('es_current_code');
    renderRegisterView();
    hide($('adminPanel'));
  }

  /* Пополнение заявки */
  function createTopupRequest(amount) {
    if (!currentUserCode) return alert('Ви не увійшли');
    amount = Number(amount);
    if (isNaN(amount) || amount <= 0) {
      alert('Введіть коректну суму');
      return;
    }
    DB.topups.push({
      id: Date.now(),
      code: currentUserCode,
      amount,
      processed: false,
      date: now()
    });
    saveData();
    alert('Заявка на поповнення створена. Очікуйте підтвердження адміна.');
  }

  /* Подписки (для примера) */
  function subscribe(type) {
    alert(`Підписка ${type} - поки не реалізовано.`);
  }

  /* Показываем историю */
  function showUserHistory() {
    if (!currentUserCode) return alert('Ви не увійшли');
    const user = byCode(currentUserCode);
    if (!user) return alert('Користувача не знайдено');
    showHistoryModal(user);
  }

  /* Показать QR код для пользователя */
  function showUserQR() {
    if (!currentUserCode) return alert('Ви не увійшли');
    showQRModal(currentUserCode);
  }

  /* Отобразить бонусы и рефералов */
  function showBonusInfo() {
    if (!currentUserCode) return alert('Ви не увійшли');
    const user = byCode(currentUserCode);
    if (!user) return alert('Користувача не знайдено');

    const inviterCodes = DB.users.filter(u => u.history.some(h => h.type.includes('Реферальний бонус (+10 грн)') && u.code !== currentUserCode));
    const html = `
      <p><strong>Ваш код:</strong> ${user.code}</p>
      <p><strong>Баланс:</strong> ${fmt(user.balance)}</p>
      <p>За перше поповнення – бонус 10 грн.</p>
      <p>За кожного друга, який використає ваш код, ви отримуєте 10 грн.</p>
      <p>Використайте ваш код, щоб запросити друзів: <strong>${user.code}</strong></p>
    `;
    modalContent.innerHTML = html;
    show(modal);
  }

  /* Сканирование QR не реализуемо в чистом HTML/JS без сервера или внешнего API */

  /* Инициализация */
  function init() {
    DB = loadData();

    if (currentUserCode && byCode(currentUserCode)) {
      renderUserView(currentUserCode);
    } else {
      renderRegisterView();
    }

    // События

    $('btnReg').onclick = () => {
      const name = $('regName').value;
      const phone = $('regPhone').value;
      const invite = $('regInvite').value;
      const user = registerUser(name, phone, invite);
      if (user) renderUserView(user.code);
    };

    $('btnUseCode').onclick = () => {
      const code = prompt('Введіть ваш унікальний код (4 цифри з #)');
      if (!code) return;
      const user = loginByCode(code);
      if (user) renderUserView(user.code);
    };

    $('btnLogout').onclick = () => {
      logout();
    };

    $('btnTopup').onclick = () => {
      const sumStr = prompt('Введіть суму для поповнення (грн)');
      if (!sumStr) return;
      createTopupRequest(sumStr);
    };

    $('btnHistory').onclick = () => {
      showUserHistory();
    };

    $('btnQR').onclick = () => {
      showUserQR();
    };

    $('btnSubscribeWeek').onclick = () => subscribe('щотижнева');
    $('btnSubscribeMonth').onclick = () => subscribe('щомісячна');

    $('btnShare').onclick = () => showBonusInfo();

    $('btnAdminLogin').onclick = () => {
      const pass = prompt('Введіть адмін-код');
      if (pass === 'admin123') {
        isAdmin = true;
        renderAdminPanel();
      } else {
        alert('Невірний адмін-код');
      }
    };

    $('btnAdminLogout').onclick = () => {
      isAdmin = false;
      hide($('adminPanel'));
    };
  }

  init();
})();
</script>

</body>
</html>

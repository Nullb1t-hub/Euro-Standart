<!doctype html>
<html lang="uk">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Euro Standart — Абонементи води</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
<!-- QR Scanner библиотека -->
<script src="https://unpkg.com/html5-qrcode" defer></script>
<style>
  :root {
    --bg-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    --btn-gradient: linear-gradient(90deg, #00c6ff, #0072ff);
    --card-bg: rgba(255 255 255 / 0.9);
  }
  body {
    font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif;
    min-height: 100vh;
    margin: 0;
    background: var(--bg-gradient);
    color: #222;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 16px 8px;
  }
  header {
    width: 100%;
    max-width: 420px;
    background: var(--card-bg);
    border-radius: 16px;
    box-shadow: 0 6px 15px rgb(0 0 0 / 0.1);
    padding: 20px 24px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    position: relative;
    overflow: hidden;
  }
  header::before {
    content: "";
    position: absolute;
    top: -60px; right: -60px;
    width: 150px; height: 150px;
    background: url('https://upload.wikimedia.org/wikipedia/commons/thumb/3/3c/Water_drop_icon.svg/120px-Water_drop_icon.svg.png') no-repeat center/contain;
    opacity: 0.08;
    pointer-events: none;
    filter: drop-shadow(0 0 2px #0072ff);
    border-radius: 50%;
  }
  .logo {
    font-weight: 800;
    font-size: 28px;
    color: #0072ff;
    user-select: none;
  }
  .info-btn {
    background: var(--btn-gradient);
    color: white;
    padding: 10px 14px;
    border-radius: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.3s ease;
    user-select: none;
    border: none;
  }
  .info-btn:hover {
    background: #005ec6;
  }
  main {
    max-width: 420px;
    width: 100%;
    background: var(--card-bg);
    border-radius: 18px;
    box-shadow: 0 10px 30px rgb(0 0 0 / 0.12);
    padding: 24px;
    display: flex;
    flex-direction: column;
    gap: 24px;
  }
  input, button {
    font-family: inherit;
  }
  input {
    width: 100%;
    padding: 12px 16px;
    border-radius: 12px;
    border: 2px solid #0072ff;
    outline-offset: 2px;
    outline-color: transparent;
    transition: outline-color 0.25s ease;
    font-size: 16px;
    box-sizing: border-box;
  }
  input:focus {
    outline-color: #00c6ff;
  }
  button {
    background: var(--btn-gradient);
    border: none;
    color: white;
    padding: 14px 0;
    border-radius: 16px;
    font-size: 18px;
    font-weight: 700;
    cursor: pointer;
    user-select: none;
    transition: background 0.3s ease;
  }
  button:disabled {
    background: #ccc;
    cursor: not-allowed;
  }
  button:hover:not(:disabled) {
    background: #005ec6;
  }
  .btn-secondary {
    background: transparent;
    border: 2px solid #0072ff;
    color: #0072ff;
  }
  .btn-secondary:hover {
    background: #0072ff;
    color: white;
  }
  .section-title {
    font-weight: 700;
    font-size: 22px;
    margin-bottom: 12px;
    color: #004a9f;
    text-align: center;
  }
  .hidden {
    display: none !important;
  }
  .user-code {
    font-size: 26px;
    font-weight: 900;
    letter-spacing: 3px;
    text-align: center;
    margin-bottom: 16px;
    color: #0072ff;
  }
  .balance {
    font-size: 20px;
    font-weight: 700;
    text-align: center;
    margin-bottom: 20px;
    color: #004a9f;
  }
  .button-group {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    justify-content: center;
  }
  .modal-backdrop {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.45);
    z-index: 2000;
  }
  .modal {
    position: fixed;
    z-index: 2100;
    top: 50%;
    left: 50%;
    max-width: 380px;
    width: 90%;
    background: white;
    border-radius: 14px;
    box-shadow: 0 12px 40px rgb(0 0 0 / 0.3);
    transform: translate(-50%, -50%);
    padding: 24px 20px 20px;
    overflow-y: auto;
    max-height: 80vh;
    font-size: 16px;
    color: #222;
  }
  .modal-header {
    font-weight: 700;
    font-size: 22px;
    margin-bottom: 16px;
    color: #0072ff;
    text-align: center;
  }
  .modal-close-btn {
    margin-top: 20px;
    background: var(--btn-gradient);
    width: 100%;
  }
  .qr-container {
    margin: 12px 0;
    text-align: center;
  }
  .qr-code {
    width: 180px;
    height: 180px;
    margin: 0 auto;
  }
  .admin-users-list {
    max-height: 300px;
    overflow-y: auto;
    margin-bottom: 12px;
  }
  .admin-user-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 12px;
    border-bottom: 1px solid #ddd;
  }
  .admin-user-info {
    font-weight: 600;
  }
  .admin-btn {
    background: #0072ff;
    border: none;
    color: white;
    padding: 8px 10px;
    border-radius: 12px;
    font-size: 14px;
    cursor: pointer;
    user-select: none;
    transition: background 0.3s ease;
  }
  .admin-btn:hover {
    background: #005ec6;
  }
  .input-inline {
    width: 70px;
    padding: 8px 12px;
    margin-left: 10px;
    border: 1px solid #0072ff;
    border-radius: 12px;
    font-size: 16px;
  }
  .info-text {
    text-align: center;
    color: #004a9f;
    font-size: 15px;
    margin-bottom: 12px;
  }
  .footer {
    margin-top: 40px;
    font-size: 14px;
    color: #bbb;
    user-select: none;
  }
</style>
</head>
<body>

<header>
  <div class="logo">Euro Standart</div>
  <button id="btnInfo" class="info-btn" aria-label="Інформація про воду">Інфо</button>
</header>

<main>
  <!-- Регистрация -->
  <section id="register-section" class="">
    <div class="section-title">Реєстрація клієнта</div>
    <input id="regName" type="text" placeholder="Ім'я" autocomplete="off" />
    <input id="regPhone" type="tel" placeholder="Телефон +380..." autocomplete="off" />
    <input id="regInvite" type="text" placeholder="Код запрошення (необов'язково)" autocomplete="off" />
    <button id="btnReg" disabled>Зареєструватися</button>
    <button id="btnUseCode" class="btn-secondary">Увійти по коду</button>
  </section>

  <!-- Личный кабинет пользователя -->
  <section id="user-section" class="hidden">
    <div class="user-code" id="userCode">#0000</div>
    <div class="balance" id="userBalance">0 грн</div>
    <div class="button-group">
      <button id="btnTopup">Поповнити (заявка)</button>
      <button id="btnQR" class="btn-secondary">QR-код</button>
      <button id="btnLogout" class="btn-secondary">Вийти</button>
    </div>
    <div class="button-group" style="margin-top: 16px;">
      <button id="btnHistory" class="btn-secondary" style="flex:1;">Історія</button>
    </div>
  </section>

  <!-- Админ панель -->
  <section id="admin-section" class="hidden" style="margin-top: 20px;">
    <div class="section-title">Адмін-панель</div>
    <div class="info-text">Введіть адмін-код для доступу</div>
    <input id="adminPassword" type="password" placeholder="Пароль admin123" autocomplete="off" />
    <button id="btnAdminLogin" disabled>Увійти</button>
    <button id="btnAdminLogout" class="btn-secondary hidden">Вийти з адмінки</button>

    <div id="adminPanelContent" class="hidden">
      <div class="admin-users-list" id="adminUsersList"></div>
      <div style="text-align:center;">
        <button id="btnScanQR" class="admin-btn" style="margin-bottom:12px;">Сканер QR-кодів</button>
      </div>
      <div id="qrScannerContainer" class="hidden" style="text-align:center;">
        <div id="qr-reader" style="width: 300px; margin: 0 auto;"></div>
        <button id="btnCloseQR" class="admin-btn" style="margin-top:10px;">Закрити сканер</button>
      </div>
    </div>
  </section>
</main>

<div id="modal-root"></div>

<footer class="footer">© Euro Standart — Система розливу води</footer>

<script>
  const STORAGE_KEY = 'eurostandart_v2';

  function safeParseJSON(s) {
    try { return JSON.parse(s); } catch (e) { return null; }
  }

  function loadData() {
    const raw = localStorage.getItem(STORAGE_KEY);
    const parsed = safeParseJSON(raw);
    if(!parsed) {
      const base = { users: [], topups: [] };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(base));
      return base;
    }
    parsed.users = parsed.users || [];
    parsed.topups = parsed.topups || [];
    return parsed;
  }
  function saveData(d) { localStorage.setItem(STORAGE_KEY, JSON.stringify(d)); }

  let DB = loadData();

  function genCode(){
    return '#' + Math.floor(1000 + Math.random()*9000);
  }

  function byCode(code){
    return DB.users.find(u => u.code === code);
  }

  function fmt(n){
    return (Number(n)||0) + ' грн';
  }

  function now(){
    return Date.now();
  }

  /* UI helpers */
  const el = id => document.getElementById(id);

  function show(el){
    el.classList.remove('hidden');
  }
  function hide(el){
    el.classList.add('hidden');
  }

  /* MODAL */
  const modalRoot = el('modal-root');
  function openModal(contentHtml) {
    const modalOverlay = document.createElement('div');
    modalOverlay.className = 'modal-backdrop';
    modalOverlay.addEventListener('click', () => closeModal());
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.innerHTML = contentHtml;
    modalOverlay.appendChild(modal);
    modalRoot.appendChild(modalOverlay);
    // Add close button inside modal if not already
    if(!modal.querySelector('.modal-close-btn')){
      const closeBtn = document.createElement('button');
      closeBtn.className = 'modal-close-btn';
      closeBtn.textContent = 'Закрити';
      closeBtn.addEventListener('click', () => closeModal());
      modal.appendChild(closeBtn);
    }
  }
  function closeModal() {
    modalRoot.innerHTML = '';
  }

  /* Escape HTML */
  function escapeHtml(s) {
    if(s === undefined || s === null) return '';
    return String(s).replace(/[&<>"']/g, c => ({
      '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
    })[c]);
  }

  /* Регистрация - валидация кнопки */
  function validateRegister() {
    const name = el('regName').value.trim();
    const phone = el('regPhone').value.trim();
    el('btnReg').disabled = !(name.length > 1 && /^\+380\d{9}$/.test(phone));
  }
  el('regName').addEventListener('input', validateRegister);
  el('regPhone').addEventListener('input', validateRegister);

  /* Регистрация - кнопка */
  el('btnReg').addEventListener('click', () => {
    const name = el('regName').value.trim();
    const phone = el('regPhone').value.trim();
    const invite = el('regInvite').value.trim();

    if(!name || !phone) return alert("Вкажіть ім'я та телефон");
    if(!/^\+380\d{9}$/.test(phone)) return alert("Телефон має бути у форматі +380XXXXXXXXX");

    // Проверка уникальности телефона
    if(DB.users.find(u => u.phone === phone)){
      alert("Користувач з таким телефоном вже існує. Будь ласка, увійдіть по коду.");
      return;
    }

    // Создаем пользователя
    let code;
    do {
      code = genCode();
    } while(byCode(code));
    const user = {
      id: now(),
      name,
      phone,
      code,
      balance: 0,
      history: [],
      invitedBy: invite || null,
      firstTopupDone: false
    };
    DB.users.push(user);

    // бонус пригласителю
    if(invite) {
      const inviter = byCode(invite);
      if(inviter){
        inviter.balance += 10;
        inviter.history.push({ type:'Реферальний бонус (реєстрація)', amount:10, time: now() });
      }
    }

    saveData(DB);
    setCurrentUser(code);
    renderUserSection();
  });

  /* Войти по коду */
  el('btnUseCode').addEventListener('click', () => {
    const code = prompt('Введіть свій код (наприклад #1234)');
    if(!code) return;
    const user = byCode(code.trim());
    if(!user) {
      alert('Користувача з таким кодом не знайдено');
      return;
    }
    setCurrentUser(user.code);
    renderUserSection();
  });

  /* Текущий пользователь */
  let currentUserCode = localStorage.getItem('es_current_code') || null;
  function setCurrentUser(code){
    currentUserCode = code;
    localStorage.setItem('es_current_code', code);
  }

  /* Выход пользователя */
  el('btnLogout').addEventListener('click', () => {
    localStorage.removeItem('es_current_code');
    currentUserCode = null;
    renderRegisterSection();
  });

  /* Рендер страницы пользователя */
  function renderUserSection(){
    if(!currentUserCode){
      renderRegisterSection();
      return;
    }
    const user = byCode(currentUserCode);
    if(!user){
      renderRegisterSection();
      return;
    }
    hide(el('register-section'));
    hide(el('admin-section'));
    show(el('user-section'));
    el('userCode').textContent = user.code;
    el('userBalance').textContent = fmt(user.balance);
  }

  /* Рендер страницы регистрации */
  function renderRegisterSection(){
    hide(el('user-section'));
    hide(el('admin-section'));
    show(el('register-section'));
  }

  /* Автоматический вход, если есть в localStorage */
  if(currentUserCode && byCode(currentUserCode)){
    renderUserSection();
  } else {
    renderRegisterSection();
  }

  /* Инфо модалка */
  el('btnInfo').addEventListener('click', () => {
    openModal(`
      <div class="modal-header">Про воду</div>
      <p>Зворотній осмос видаляє розчинені домішки і метали.<br />
      УФ-лампа знешкоджує мікроорганізми.<br />
      Активоване вугілля покращує смак і прибирає запахи.<br /><br />
      <strong>Адреса видачі води:</strong><br />
      Київ, проспект Європейського Союзу, 19/3

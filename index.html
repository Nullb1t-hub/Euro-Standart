<!doctype html>
<html lang="uk">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Euro Standart — Абонементи води</title>

<!-- Tailwind CSS CDN -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

<!-- QRCode library -->
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>

<!-- HTML5 QR scanner library -->
<script src="https://unpkg.com/html5-qrcode@2.3.7/minified/html5-qrcode.min.js"></script>

<style>
  :root {
    /* Слегка приглушённая палитра (меньше насыщенного синего) */
    --blue-light: #60a5a8; /* was #3b82f6 */
    --blue-dark: #0f766e;  /* was #1e40af */
    --bg-gradient-start: #eefdfd; /* softer */
    --bg-gradient-end: #dff7f6;
    --card-bg: #ffffffcc;
    --shadow: rgba(15, 118, 110, 0.18);
  }

  body {
    font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif;
    background: linear-gradient(180deg, var(--bg-gradient-start), var(--bg-gradient-end));
    min-height: 100vh;
    padding: 20px;
    color: var(--blue-dark);
  }

  .card {
    background: var(--card-bg);
    border-radius: 20px;
    box-shadow: 0 10px 25px var(--shadow);
    backdrop-filter: saturate(180%) blur(12px);
    padding: 20px;
    transition: box-shadow 0.3s ease;
  }
  .card:hover {
    box-shadow: 0 15px 40px var(--shadow);
  }

  .btn-primary {
    background: linear-gradient(90deg, #158d88, #60a5a8);
    color: white;
    font-weight: 600;
    border-radius: 12px;
    padding: 12px 20px;
    box-shadow: 0 4px 14px rgba(96,165,168,0.28);
    transition: background 0.3s ease;
  }
  .btn-primary:hover {
    background: linear-gradient(90deg, #0f766e, #158d88);
  }
  .btn-outline {
    border: 2px solid var(--blue-light);
    color: var(--blue-dark);
    font-weight: 600;
    border-radius: 12px;
    padding: 10px 18px;
    background: transparent;
    transition: background 0.3s ease, color 0.3s ease;
  }
  .btn-outline:hover {
    background: var(--blue-light);
    color: white;
  }

  input, select {
    border-radius: 12px;
    border: 2px solid var(--blue-light);
    padding: 10px 15px;
    font-weight: 500;
    outline-offset: 2px;
    outline-color: #9ee7e3;
    transition: border-color 0.3s ease;
  }
  input:focus, select:focus {
    border-color: var(--blue-dark);
  }

  header {
    margin-bottom: 25px;
  }

  .fade-in {
    animation: fadeInUp 0.5s ease forwards;
  }
  @keyframes fadeInUp {
    from { opacity: 0; transform: translateY(12px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .qr-canvas {
    margin: auto;
    display: block;
  }

  /* Scrollbars */
  ::-webkit-scrollbar {
    width: 8px;
  }
  ::-webkit-scrollbar-track {
    background: #e6f7f6;
  }
  ::-webkit-scrollbar-thumb {
    background: var(--blue-light);
    border-radius: 10px;
  }

  /* Small helpers for modals etc */
  .modal-backdrop { background: rgba(0,0,0,0.4); }
</style>
</head>
<body>

<div class="max-w-4xl mx-auto space-y-8">
  <header class="flex items-center justify-between">
    <div class="flex items-center gap-4">
      <div class="w-16 h-16 rounded-xl bg-gradient-to-r from-[#158d88] to-[#60a5a8] flex items-center justify-center font-extrabold text-white text-2xl select-none cursor-default">ES</div>
      <div>
        <div class="text-[var(--blue-dark)] font-semibold text-sm select-none">Euro Standart</div>
        <h1 class="text-3xl font-extrabold leading-tight select-none">Точка розливу — Абонементи води</h1>
      </div>
    </div>
    <div class="flex items-center gap-4">
      <div class="text-[var(--blue-dark)] text-sm select-none mr-2">Зворотній осмос • УФ-лампа • Активоване вугілля</div>
      <!-- Info button added -->
      <button id="btnInfo" class="btn-outline text-sm">Інфо</button>
    </div>
  </header>

  <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">

    <!-- Регистрация / Пользователь -->
    <section class="lg:col-span-2 card relative min-h-[440px]">

      <!-- Регистрация -->
      <div id="view-register" class="fade-in space-y-5">
        <h2 class="text-xl font-bold text-[var(--blue-dark)]">Реєстрація клієнта</h2>
        <p class="text-[var(--blue-dark)] font-medium">Введіть ім'я та телефон. Можна вказати код запрошення друга.</p>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-3">
          <input id="regName" type="text" placeholder="Ім'я" autocomplete="name" />
          <input id="regPhone" type="tel" placeholder="Телефон +380..." autocomplete="tel" />
          <input id="regInvite" type="text" placeholder="Код запрошення (необов'язково)" class="md:col-span-2" autocomplete="off" />
          <button id="btnReg" class="btn-primary md:col-span-1">Зареєструватися</button>
          <button id="btnUseCode" class="btn-outline md:col-span-1">Увійти по коду</button>
        </div>
      </div>

      <!-- Пользователь -->
      <div id="view-user" class="hidden fade-in flex flex-col space-y-6">
        <div class="flex justify-between items-center">
          <div>
            <div class="text-sm font-semibold text-[var(--blue-dark)] select-none">Ваш індивідуальний код</div>
            <div id="userCode" class="text-3xl font-extrabold text-[var(--blue-dark)] select-text cursor-text">#0000</div>
          </div>
          <div class="text-right">
            <div class="text-sm font-semibold text-[var(--blue-dark)] select-none">Баланс</div>
            <div id="userBalance" class="text-2xl font-extrabold text-[var(--blue-dark)] select-text cursor-default">0 грн</div>
          </div>
        </div>

        <div class="flex gap-4 flex-wrap">
          <button id="btnTopup" class="btn-primary flex-1 min-w-[160px]">Поповнити (заявка)</button>
          <button id="btnHistory" class="btn-outline flex-1 min-w-[160px]">Історія</button>
          <button id="btnQR" class="btn-outline flex-1 min-w-[160px]">Показати QR-код</button>
        </div>

        <div class="flex gap-4 flex-wrap">
          <button id="btnSubscribeWeek" class="btn-outline flex-1 min-w-[160px]">Підписка: щотижня</button>
          <button id="btnSubscribeMonth" class="btn-outline flex-1 min-w-[160px]">Підписка: щомісяця</button>
        </div>

        <div>
          <button id="btnShare" class="btn-primary w-full">Бонуси та реферальне</button>
        </div>

        <div>
          <button id="btnLogout" class="btn-outline w-full">Вийти</button>
        </div>
      </div>

      <!-- QR Код Модал -->
      <div id="qrModal" class="fixed inset-0 modal-backdrop flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-2xl p-6 max-w-sm w-full text-center shadow-lg relative">
          <h3 class="text-xl font-bold mb-4 text-[var(--blue-dark)]">Ваш QR-код</h3>
          <canvas id="qrCanvas" class="qr-canvas mx-auto mb-4"></canvas>
          <button id="btnCloseQR" class="btn-outline w-full">Закрити</button>
        </div>
      </div>

    </section>

    <!-- Адмінка -->
    <aside class="card space-y-6 min-h-[440px]">
      <h2 class="text-xl font-bold text-[var(--blue-dark)] select-none">Адмін-панель</h2>
      <p class="text-[var(--blue-dark)] font-medium select-none">Увійдіть для обробки заявок і керування користувачами.</p>

      <button id="btnAdminLogin" class="btn-primary w-full">Увійти (адмін)</button>

      <div id="adminPanel" class="hidden flex flex-col space-y-4">
        <div>
          <h3 class="text-lg font-semibold text-[var(--blue-dark)] select-none mb-2">Заявки на поповнення</h3>
          <div id="topupsList" class="max-h-48 overflow-y-auto rounded border border-[#cfeeea] p-3 space-y-3 bg-white"></div>
        </div>

        <div>
          <h3 class="text-lg font-semibold text-[var(--blue-dark)] select-none mb-2">Користувачі</h3>
          <div id="usersList" class="max-h-64 overflow-y-auto rounded border border-[#cfeeea] p-3 space-y-3 bg-white"></div>
        </div>

        <!-- Scan QR button for admin -->
        <div>
          <button id="btnScanQR" class="btn-outline w-full">Сканувати QR</button>
        </div>

        <button id="btnAdminLogout" class="btn-outline w-full">Вийти з адмінки</button>
      </div>
    </aside>

  </main>

  <footer class="text-center text-[var(--blue-dark)] text-sm select-none">© Euro Standart — Система розливу води</footer>
</div>

<!-- Модал: Історія -->
<div id="modal" class="fixed inset-0 bg-black/30 flex items-center justify-center p-4 hidden z-40">
  <div class="bg-white rounded-2xl p-6 max-w-lg w-full shadow-lg max-h-[80vh] overflow-y-auto relative">
    <div id="modalContent"></div>
    <button id="modalClose" class="btn-outline mt-6 w-full">Закрити</button>
  </div>
</div>

<!-- Admin: Scan modal -->
<div id="scanModal" class="fixed inset-0 modal-backdrop flex items-center justify-center p-4 hidden z-50">
  <div class="bg-white rounded-2xl p-6 max-w-xl w-full shadow-lg relative">
    <h3 class="text-xl font-bold mb-3 text-[var(--blue-dark)]">Сканер QR — Адмін</h3>
    <div id="qrScannerRegion" class="w-full mb-4" style="min-height:260px"></div>
    <div id="scanInfo" class="text-[var(--blue-dark)] mb-4"></div>
    <div class="flex gap-3">
      <button id="btnStopScan" class="btn-outline flex-1">Зупинити скан</button>
      <button id="btnCloseScan" class="btn-primary flex-1">Закрити</button>
    </div>
  </div>
</div>

<!-- Admin: After-scan user action modal -->
<div id="scanUserModal" class="fixed inset-0 modal-backdrop flex items-center justify-center p-4 hidden z-60">
  <div class="bg-white rounded-2xl p-6 max-w-md w-full shadow-lg relative">
    <h3 class="text-xl font-bold mb-3 text-[var(--blue-dark)]" id="scanUserTitle">Користувач</h3>
    <div id="scanUserContent" class="mb-4 text-[var(--blue-dark)]"></div>

    <div class="grid grid-cols-1 gap-3">
      <input id="adminAdjustAmount" type="number" placeholder="Сума для зарахування (грн)" />
      <div class="flex gap-2">
        <button id="btnAdminConfirmPay" class="btn-primary flex-1">Підтвердити оплату</button>
        <button id="btnAdminCancelPay" class="btn-outline flex-1">Відхилити</button>
      </div>
      <button id="btnCloseScanUser" class="btn-outline w-full">Закрити</button>
    </div>
  </div>
</div>

<!-- Info modal (header) -->
<div id="infoModal" class="fixed inset-0 modal-backdrop flex items-center justify-center p-4 hidden z-50">
  <div class="bg-white rounded-2xl p-6 max-w-2xl w-full shadow-lg relative">
    <h3 class="text-2xl font-bold mb-3 text-[var(--blue-dark)]">Про воду та сервіс Euro Standart</h3>
    <div class="text-[var(--blue-dark)] space-y-3">
      <p><strong>Чому наша вода — корисна:</strong> Ми використовуємо багатоступеневу систему очищення: зворотній осмос, УФ-лампу та активоване вугілля — для видалення домішок, хлору та мікроорганізмів.</p>
      <p><strong>Як працює сервіс:</strong> Ви реєструєтеся, поповнюєте баланс (через заявку) та приходите на точку розливу. Адмін сканує ваш QR-код та зараховує оплату в моменті.</p>
      <p><strong>Чому це зручно:</strong> Проста реєстрація, історія операцій, бонуси за запрошених друзів та швидка обробка поповнень адміністратором прямо на точці.</p>
      <p><strong>Навіщо це корисно:</strong> Контроль якості, швидке обслуговування та зручна система бонусів — усе в одній простій веб-адмінці.</p>
    </div>
    <div class="mt-6">
      <button id="btnCloseInfo" class="btn-primary w-full">Закрити</button>
    </div>
  </div>
</div>

<script>
(() => {
  const STORAGE_KEY = 'eurostandart_v2';

  /* Data structure */
  let DB = null;

  /* DOM helpers */
  const $ = id => document.getElementById(id);
  const show = el => el.classList.remove('hidden');
  const hide = el => el.classList.add('hidden');

  /* Modal */
  const modal = $('modal');
  const modalContent = $('modalContent');
  const modalClose = $('modalClose');
  modalClose.onclick = () => hide(modal);

  /* QR Modal */
  const qrModal = $('qrModal');
  const qrCanvas = $('qrCanvas');
  const btnCloseQR = $('btnCloseQR');
  btnCloseQR.onclick = () => hide(qrModal);

  /* Scan Modal elements */
  const scanModal = $('scanModal');
  const qrScannerRegion = $('qrScannerRegion');
  const scanInfo = $('scanInfo');
  const btnStopScan = $('btnStopScan');
  const btnCloseScan = $('btnCloseScan');

  const scanUserModal = $('scanUserModal');
  const scanUserTitle = $('scanUserTitle');
  const scanUserContent = $('scanUserContent');
  const adminAdjustAmount = $('adminAdjustAmount');
  const btnAdminConfirmPay = $('btnAdminConfirmPay');
  const btnAdminCancelPay = $('btnAdminCancelPay');
  const btnCloseScanUser = $('btnCloseScanUser');

  /* Info modal */
  const infoModal = $('infoModal');
  const btnInfo = $('btnInfo');
  const btnCloseInfo = $('btnCloseInfo');

  if (btnInfo) btnInfo.onclick = () => show(infoModal);
  if (btnCloseInfo) btnCloseInfo.onclick = () => hide(infoModal);

  if (btnCloseInfo) { /* already handled above */ }
  // If btnCloseInfo missing (we created it), attach here
  if (!btnCloseInfo) {
    // create handler for dynamically present button
    document.addEventListener('click', e => {
      if (e.target && e.target.id === 'btnCloseInfo') hide(infoModal);
    });
  }

  btnStopScan.onclick = () => stopScanner();
  btnCloseScan.onclick = () => {
    stopScanner();
    hide(scanModal);
  };

  btnCloseScanUser.onclick = () => hide(scanUserModal);

  /* State */
  let currentUserCode = localStorage.getItem('es_current_code') || null;
  let isAdmin = false;
  let html5QrcodeScanner = null;

  /* Load data or init */
  function safeParseJSON(str) {
    try { return JSON.parse(str); }
    catch { return null; }
  }
  function loadData() {
    const raw = localStorage.getItem(STORAGE_KEY);
    const parsed = safeParseJSON(raw);
    if (!parsed || !parsed.users || !parsed.topups || !parsed.subscriptions) {
      const base = { users: [], topups: [], subscriptions: [] };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(base));
      return base;
    }
    return parsed;
  }
  function saveData() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(DB));
  }

  function genCode() {
    let code;
    do {
      code = '#' + Math.floor(1000 + Math.random() * 9000);
    } while (DB.users.find(u => u.code === code));
    return code;
  }

  function byCode(code) {
    return DB.users.find(u => u.code === code);
  }

  function fmt(n) {
    return (Number(n) || 0) + ' грн';
  }

  function now() {
    return Date.now();
  }

  /* Escape HTML */
  function escapeHtml(s) {
    if (s === undefined || s === null) return '';
    return String(s).replace(/[&<>"']/g, c =>
      ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[c])
    );
  }

  /* Render */

  function renderUserView(code) {
    const user = byCode(code);
    if (!user) return alert('Користувача не знайдено');
    hide($('view-register'));
    show($('view-user'));

    $('userCode').textContent = user.code;
    $('userBalance').textContent = fmt(user.balance);
  }

  function renderRegisterView() {
    hide($('view-user'));
    show($('view-register'));
  }

  function renderAdminPanel() {
    // Show admin panel UI and fill users and topups
    show($('adminPanel'));

    // Topups list
    const topups = DB.topups.filter(t => !t.processed);
    const topupsList = $('topupsList');
    topupsList.innerHTML = '';
    if (!topups.length) {
      topupsList.innerHTML = '<p class="text-[var(--blue-dark)] select-none">Немає заявок на поповнення</p>';
    } else {
      topups.forEach(t => {
        const u = byCode(t.code) || { name: '—' };
        const div = document.createElement('div');
        div.className = 'flex justify-between items-center bg-[#e8fbfa] rounded p-2';
        div.innerHTML = `
          <div>
            <p class="font-semibold text-[var(--blue-dark)]">${escapeHtml(u.name)} <span class="text-sm text-[#6bbfbc]">(${escapeHtml(t.code)})</span></p>
            <p class="text-sm text-[var(--blue-dark)]">Сума: <strong>${t.amount} грн</strong> — заявка</p>
          </div>
          <div class="flex gap-2">
            <button class="btn-primary btn-proc px-3 py-1 rounded" data-id="${t.id}">Підтвердити</button>
            <button class="btn-outline btn-rej px-3 py-1 rounded" data-id="${t.id}">Відхилити</button>
          </div>
        `;
        topupsList.appendChild(div);
      });
    }

    // Users list
    const usersList = $('usersList');
    usersList.innerHTML = '';
    if (!DB.users.length) {
      usersList.innerHTML = '<p class="text-[var(--blue-dark)] select-none">Немає користувачів</p>';
    } else {
      DB.users.forEach(u => {
        const div = document.createElement('div');
        div.className = 'flex flex-col gap-1 p-2 rounded border border-[#cfeeea] bg-[#f7fffe]';
        div.innerHTML = `
          <div class="flex justify-between items-center">
            <div>
              <p class="font-semibold text-[var(--blue-dark)]">${escapeHtml(u.name)}</p>
              <p class="text-sm text-[var(--blue-dark)] select-text">${escapeHtml(u.phone)}</p>
              <p class="text-sm text-[var(--blue-dark)] select-text">Код: <strong>${u.code}</strong></p>
              <p class="text-sm text-[var(--blue-dark)] font-semibold">Баланс: ${fmt(u.balance)}</p>
            </div>
            <div class="flex flex-col gap-2">
              <button class="btn-outline btn-adjust px-3 py-1 rounded" data-code="${u.code}">Регул.</button>
              <button class="btn-outline btn-viewhist px-3 py-1 rounded" data-code="${u.code}">Іст.</button>
              <button class="btn-outline btn-populateqr px-3 py-1 rounded" data-code="${u.code}">QR</button>
            </div>
          </div>
        `;
        usersList.appendChild(div);
      });
    }

    // Attach button handlers for topups
    document.querySelectorAll('.btn-proc').forEach(btn => {
      btn.onclick = () => processTopup(Number(btn.dataset.id), true);
    });
    document.querySelectorAll('.btn-rej').forEach(btn => {
      btn.onclick = () => processTopup(Number(btn.dataset.id), false);
    });

    // Attach button handlers for users list
    document.querySelectorAll('.btn-adjust').forEach(btn => {
      btn.onclick = () => {
        const code = btn.dataset.code;
        const sumStr = prompt('Введіть суму (від\'ємне число для списання)', '100');
        if (!sumStr) return;
        const sum = Number(sumStr);
        if (isNaN(sum)) {
          alert('Некоректна сума');
          return;
        }
        adjustBalance(code, sum, 'Ручна корекція');
        alert('Баланс змінено');
        renderAdminPanel();
      };
    });
    document.querySelectorAll('.btn-viewhist').forEach(btn => {
      btn.onclick = () => {
        const code = btn.dataset.code;
        const user = byCode(code);
        if (!user) return alert('Користувача не знайдено');
        showHistoryModal(user);
      };
    });
    document.querySelectorAll('.btn-populateqr').forEach(btn => {
      btn.onclick = () => {
        const code = btn.dataset.code;
        showQRModal(code);
      };
    });
  }

  /* Process topup: confirmed or rejected */
  function processTopup(id, confirm) {
    const idx = DB.topups.findIndex(t => t.id === id);
    if (idx === -1) return alert('Заявка не знайдена');
    if (confirm) {
      // Поповнюємо баланс користувача
      const t = DB.topups[idx];
      const user = byCode(t.code);
      if (!user) return alert('Користувача не знайдено');
      user.balance = (user.balance || 0) + t.amount;
      if (!user.history) user.history = [];
      user.history.push({ date: now(), type: 'Поповнення (адмін)', amount: t.amount });
      // Якщо перше поповнення, +10 бонус
      if (!DB.subscriptions.includes(user.code)) {
        user.balance += 10;
        user.history.push({ date: now(), type: 'Бонус 10 грн (перше поповнення)', amount: 10 });
        DB.subscriptions.push(user.code);
   